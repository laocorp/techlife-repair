// Prisma Schema for RepairApp
// PostgreSQL Direct Connection

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ USUARIOS Y EMPRESAS ============

model Empresa {
  id                    String    @id @default(uuid())
  nombre                String
  ruc                   String?
  razon_social          String?
  nombre_comercial      String?
  direccion             String?
  telefono              String?
  email                 String?
  logo_url              String?
  
  // Facturación SRI
  establecimiento       String    @default("001")
  punto_emision         String    @default("001")
  ambiente_sri          String    @default("pruebas") // 'pruebas' | 'produccion'
  obligado_contabilidad Boolean   @default(false)
  
  // Certificado
  certificado_p12_url   String?
  certificado_password  String?
  certificado_vence     DateTime?
  
  // Suscripción
  plan                  String    @default("trial")
  suscripcion_activa    Boolean   @default(true)
  fecha_vencimiento     DateTime?
  
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt
  
  // Relaciones
  usuarios              Usuario[]
  clientes              Cliente[]
  ordenes               OrdenServicio[]
  productos             Producto[]
  ventas                Venta[]
  notificaciones        Notificacion[]
  secuenciales          Secuencial[]
  marcas                Marca[]
  modelos               Modelo[]
  cajas                 Caja[]
  contabilidad          Contabilidad[]
  suscripciones         Suscripcion[]
  facturas              FacturacionElectronica[]
  pagos                 Pago[]
  roles                 Role[]
  activity_logs         ActivityLog[]
  
  @@map("empresas")
}

model Usuario {
  id          String    @id @default(uuid())
  email       String    @unique
  password    String
  nombre      String
  rol         String    @default("tecnico") // 'admin' | 'tecnico' | 'vendedor' - Mantener para compatibilidad
  role_id     String?   // Nueva relación con Role (opcional para compatibilidad)
  role        Role?     @relation(fields: [role_id], references: [id])
  activo      Boolean   @default(true)
  empresa_id  String
  empresa     Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  
  // Relaciones
  ordenes_asignadas OrdenServicio[] @relation("TecnicoAsignado")
  ordenes_creadas   OrdenServicio[] @relation("CreadoPor")
  cajas             Caja[]
  pagos_registrados Pago[]
  activity_logs     ActivityLog[]
  
  @@map("usuarios")
}

// ============ CLIENTES ============

model Cliente {
  id              String    @id @default(uuid())
  nombre          String
  identificacion  String?
  tipo_id         String    @default("cedula") // 'cedula' | 'ruc' | 'pasaporte'
  email           String?
  telefono        String?
  direccion       String?
  password        String?   // Para portal de clientes
  
  empresa_id      String
  empresa         Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  
  // Relaciones
  ordenes         OrdenServicio[]
  ventas          Venta[]
  
  @@unique([empresa_id, identificacion])
  @@map("clientes")
}

// ============ ÓRDENES DE SERVICIO ============

model OrdenServicio {
  id                  String    @id @default(uuid())
  numero              String    // Ej: "ORD-001-0001"
  
  // Cliente
  cliente_id          String
  cliente             Cliente   @relation(fields: [cliente_id], references: [id])
  
  // Equipo
  equipo_tipo         String    // 'herramienta' | 'electrodomestico' | 'otro'
  equipo_marca        String
  equipo_modelo       String?
  equipo_serie        String?
  equipo_accesorios   String?
  
  // Problema
  problema_reportado  String
  diagnostico         String?
  solucion            String?
  
  // Estado
  estado              String    @default("recibido") // 'recibido' | 'diagnostico' | 'cotizado' | 'aprobado' | 'reparando' | 'listo' | 'entregado' | 'cancelado'
  prioridad           String    @default("normal") // 'baja' | 'normal' | 'alta' | 'urgente'
  
  // Costos
  costo_estimado      Decimal?  @db.Decimal(10, 2)
  costo_final         Decimal?  @db.Decimal(10, 2)
  anticipo            Decimal?  @db.Decimal(10, 2)
  mano_obra           Decimal   @default(0) @db.Decimal(10, 2)
  
  // Pagos Status
  estado_pago         String    @default("pendiente") // 'pendiente' | 'parcial' | 'pagado'
  
  // Fechas
  fecha_recepcion     DateTime  @default(now())
  fecha_promesa       DateTime?
  fecha_entrega       DateTime?
  
  // Técnico
  tecnico_id          String?
  tecnico             Usuario?  @relation("TecnicoAsignado", fields: [tecnico_id], references: [id])
  
  // Creador
  creado_por_id       String?
  creado_por          Usuario?  @relation("CreadoPor", fields: [creado_por_id], references: [id])
  
  // Empresa
  empresa_id          String
  empresa             Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  
  // QR
  qr_code             String?
  
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  // Relaciones Detalladas
  repuestos           OrdenRepuesto[]
  pagos               Pago[]
  
  @@unique([empresa_id, numero])
  @@map("ordenes_servicio")
}

model OrdenRepuesto {
  id              String    @id @default(uuid())
  
  orden_id        String
  orden           OrdenServicio @relation(fields: [orden_id], references: [id], onDelete: Cascade)
  
  producto_id     String
  producto        Producto  @relation(fields: [producto_id], references: [id])
  
  cantidad        Int       @default(1)
  precio_unitario Decimal   @db.Decimal(10, 2)
  subtotal        Decimal   @db.Decimal(10, 2) // cantidad * precio_unitario
  
  created_at      DateTime  @default(now())
  
  @@map("ordenes_repuestos")
}

model Pago {
  id              String         @id @default(uuid())
  
  orden_id        String
  orden           OrdenServicio  @relation(fields: [orden_id], references: [id], onDelete: Cascade)
  
  monto           Decimal        @db.Decimal(10, 2)
  metodo          String         @default("efectivo") // 'efectivo' | 'tarjeta' | 'transferencia' | 'cheque' | 'otro'
  referencia      String?        // Nro comprobante, voucher, etc.
  nota            String?
  fecha           DateTime       @default(now())
  
  registrado_por_id String?
  registrado_por    Usuario?     @relation(fields: [registrado_por_id], references: [id])
  
  caja_movimiento_id String?     @unique
  caja_movimiento    CajaMovimiento? @relation(fields: [caja_movimiento_id], references: [id])

  empresa_id      String
  empresa         Empresa        @relation(fields: [empresa_id], references: [id], onDelete: Cascade)

  created_at      DateTime       @default(now())
  
  @@map("pagos")
}

// ============ INVENTARIO ============

model Producto {
  id              String    @id @default(uuid())
  codigo          String
  nombre          String
  descripcion     String?
  categoria       String?
  marca           String?
  
  precio_compra   Decimal   @db.Decimal(10, 2)
  precio_venta    Decimal   @db.Decimal(10, 2)
  stock           Int       @default(0)
  stock_minimo    Int       @default(5)
  
  activo          Boolean   @default(true)
  
  empresa_id      String
  empresa         Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  
  // Relaciones
  detalles_venta  VentaDetalle[]
  ordenes         OrdenRepuesto[]
  
  @@unique([empresa_id, codigo])
  @@map("productos")
}

// ============ VENTAS / POS ============

model Venta {
  id              String    @id @default(uuid())
  numero          String    // Ej: "VTA-001-0001"
  
  cliente_id      String?
  cliente         Cliente?  @relation(fields: [cliente_id], references: [id])
  
  subtotal        Decimal   @db.Decimal(10, 2)
  iva             Decimal   @db.Decimal(10, 2)
  descuento       Decimal   @default(0) @db.Decimal(10, 2)
  total           Decimal   @db.Decimal(10, 2)
  
  metodo_pago     String    @default("efectivo") // 'efectivo' | 'tarjeta' | 'transferencia'
  estado          String    @default("completada") // 'pendiente' | 'completada' | 'anulada'
  
  empresa_id      String
  empresa         Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  
  // Relaciones
  detalles        VentaDetalle[]
  factura         FacturacionElectronica?
  
  @@unique([empresa_id, numero])
  @@map("ventas")
}

model VentaDetalle {
  id              String    @id @default(uuid())
  
  venta_id        String
  venta           Venta     @relation(fields: [venta_id], references: [id], onDelete: Cascade)
  
  producto_id     String
  producto        Producto  @relation(fields: [producto_id], references: [id])
  
  cantidad        Int
  precio_unitario Decimal   @db.Decimal(10, 2)
  subtotal        Decimal   @db.Decimal(10, 2)
  
  @@map("ventas_detalle")
}

// ============ NOTIFICACIONES ============

model Notificacion {
  id          String    @id @default(uuid())
  tipo        String    // 'orden' | 'pago' | 'sistema' | 'completada'
  titulo      String
  mensaje     String
  leida       Boolean   @default(false)
  link        String?
  
  empresa_id  String
  empresa     Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  
  created_at  DateTime  @default(now())
  
  @@map("notificaciones")
}

// ============ SECUENCIALES ============

model Secuencial {
  id              String    @id @default(uuid())
  tipo_documento  String    // 'factura' | 'nota_credito' | 'orden' | 'venta'
  establecimiento String
  punto_emision   String
  secuencial      Int       @default(1)
  
  empresa_id      String
  empresa         Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  
  @@unique([empresa_id, tipo_documento, establecimiento, punto_emision])
  @@map("secuenciales")
}

// ============ SRI CONFIGURACIÓN ============

// model SriConfiguracion {
//   id                          String    @id @default(uuid())
//   empresa_id                  String    @unique
  
//   razon_social                String?
//   nombre_comercial            String?
//   direccion_matriz            String?
//   establecimiento             String    @default("001")
//   punto_emision               String    @default("001")
//   direccion_establecimiento   String?
//   ambiente                    String    @default("pruebas")
//   obligado_contabilidad       Boolean   @default(false)
//   contribuyente_especial      String?
//   tipo_emision                String    @default("1")
  
//   firma_electronica_configurada Boolean @default(false)
//   firma_electronica_vence     DateTime?
  
//   created_at                  DateTime  @default(now())
//   updated_at                  DateTime  @updatedAt
  
//   @@map("sri_configuracion")
// }

// ============ MARCAS Y MODELOS ============

model Marca {
  id          String    @id @default(uuid())
  nombre      String
  pais        String?
  activo      Boolean   @default(true)
  
  empresa_id  String
  empresa     Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  
  modelos     Modelo[]
  
  @@map("marcas")
}

model Modelo {
  id              String    @id @default(uuid())
  nombre          String
  tipo_equipo     String?
  activo          Boolean   @default(true)
  
  marca_id        String
  marca           Marca     @relation(fields: [marca_id], references: [id], onDelete: Cascade)
  
  empresa_id      String
  empresa         Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  
  @@map("modelos")
}

// ============ CAJA ============

model Caja {
  id              String    @id @default(uuid())
  monto_apertura  Decimal   @db.Decimal(10, 2)
  monto_cierre    Decimal?  @db.Decimal(10, 2)
  estado          String    @default("abierta") // 'abierta' | 'cerrada'
  
  empresa_id      String
  empresa         Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  
  usuario_id      String?
  usuario         Usuario?  @relation(fields: [usuario_id], references: [id])
  
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  
  movimientos     CajaMovimiento[]
  
  @@map("cajas")
}

model CajaMovimiento {
  id          String    @id @default(uuid())
  tipo        String    // 'ingreso' | 'egreso'
  monto       Decimal   @db.Decimal(10, 2)
  concepto    String?
  
  caja_id     String
  caja        Caja      @relation(fields: [caja_id], references: [id], onDelete: Cascade)
  
  pago        Pago?
  
  created_at  DateTime  @default(now())
  
  @@map("caja_movimientos")
}

// ============ CONTABILIDAD ============

model Contabilidad {
  id          String    @id @default(uuid())
  tipo        String    // 'ingreso' | 'egreso'
  categoria   String
  monto       Decimal   @db.Decimal(10, 2)
  descripcion String?
  fecha       DateTime  @default(now())
  
  empresa_id  String
  empresa     Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  
  @@map("contabilidad")
}

// ============ PLANES Y SUSCRIPCIONES ============

model Plan {
  id              String    @id @default(uuid())
  nombre          String
  tipo            String
  precio          Decimal   @db.Decimal(10, 2)
  
  max_usuarios    Int       @default(1)
  max_ordenes_mes Int       @default(50)
  max_productos   Int       @default(100)
  max_facturas_mes Int      @default(20)
  
  activo          Boolean   @default(true)
  
  created_at      DateTime  @default(now())
  
  suscripciones   Suscripcion[]
  
  @@map("planes")
}

model Suscripcion {
  id              String    @id @default(uuid())
  estado          String    @default("activa") // 'activa' | 'trial' | 'vencida' | 'cancelada'
  periodo         String    @default("mensual") // 'mensual' | 'anual'
  fecha_inicio    DateTime  @default(now())
  fecha_fin       DateTime?
  
  empresa_id      String
  empresa         Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  
  plan_id         String?
  plan            Plan?     @relation(fields: [plan_id], references: [id])
  
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  
  @@map("suscripciones")
}

// ============ FACTURACIÓN ELECTRÓNICA ============

model FacturacionElectronica {
  id                      String    @id @default(uuid())
  numero                  String
  tipo_comprobante        String
  
  cliente_nombre          String
  cliente_identificacion  String
  
  subtotal                Decimal   @db.Decimal(10, 2)
  iva                     Decimal   @db.Decimal(10, 2)
  total                   Decimal   @db.Decimal(10, 2)
  
  estado                  String    @default("pendiente") // 'pendiente' | 'autorizado' | 'rechazado' | 'anulado'
  clave_acceso            String?
  numero_autorizacion     String?
  ambiente                String?   // '1' pruebas | '2' produccion
  xml_generado            String?   @db.Text

  
  empresa_id              String
  empresa                 Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)

  venta_id                String?   @unique
  venta                   Venta?    @relation(fields: [venta_id], references: [id])
  
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt
  
  @@map("facturacion_electronica")
}

// ============ RBAC - ROLES Y PERMISOS ============

model Role {
  id          String   @id @default(uuid())
  nombre      String   @unique
  descripcion String?
  es_sistema  Boolean  @default(false) // Roles del sistema no se pueden eliminar
  empresa_id  String?  // null = rol global, string = rol de empresa específica
  empresa     Empresa? @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  permisos    RolePermission[]
  usuarios    Usuario[]
  
  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  codigo      String   @unique  // ej: "orders.create", "inventory.delete"
  nombre      String            // ej: "Crear Órdenes"
  modulo      String            // ej: "orders", "inventory", "cash"
  descripcion String?
  
  roles       RolePermission[]
  
  @@map("permissions")
}

model RolePermission {
  role_id       String
  permission_id String
  role          Role       @relation(fields: [role_id], references: [id], onDelete: Cascade)
  permission    Permission @relation(fields: [permission_id], references: [id], onDelete: Cascade)
  
  @@id([role_id, permission_id])
  @@map("role_permissions")
}

model ActivityLog {
  id          String   @id @default(uuid())
  empresa_id  String
  usuario_id  String?
  accion      String   // "create", "update", "delete", "login", "logout"
  modulo      String   // "orders", "inventory", "users", etc.
  entidad_id  String?  // ID del registro afectado
  detalles    Json?    // Datos adicionales (antes/después)
  ip_address  String?
  user_agent  String?
  created_at  DateTime @default(now())
  
  empresa     Empresa  @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  usuario     Usuario? @relation(fields: [usuario_id], references: [id], onDelete: SetNull)
  
  @@index([empresa_id, created_at])
  @@index([usuario_id])
  @@index([modulo, accion])
  @@map("activity_logs")
}
