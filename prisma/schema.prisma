// Prisma Schema for RepairApp
// PostgreSQL Direct Connection

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ USUARIOS Y EMPRESAS ============

model Empresa {
  id                    String    @id @default(uuid())
  nombre                String
  ruc                   String?
  razon_social          String?
  nombre_comercial      String?
  direccion             String?
  telefono              String?
  email                 String?
  logo_url              String?
  
  // Facturación SRI
  establecimiento       String    @default("001")
  punto_emision         String    @default("001")
  ambiente_sri          String    @default("pruebas") // 'pruebas' | 'produccion'
  obligado_contabilidad Boolean   @default(false)
  
  // Certificado
  certificado_p12_url   String?
  certificado_password  String?
  certificado_vence     DateTime?
  
  // Suscripción
  plan                  String    @default("trial")
  suscripcion_activa    Boolean   @default(true)
  fecha_vencimiento     DateTime?
  
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt
  
  // Relaciones
  usuarios              Usuario[]
  clientes              Cliente[]
  ordenes               OrdenServicio[]
  productos             Producto[]
  ventas                Venta[]
  notificaciones        Notificacion[]
  secuenciales          Secuencial[]
  
  @@map("empresas")
}

model Usuario {
  id          String    @id @default(uuid())
  email       String    @unique
  password    String
  nombre      String
  rol         String    @default("tecnico") // 'admin' | 'tecnico' | 'vendedor'
  activo      Boolean   @default(true)
  empresa_id  String
  empresa     Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  
  // Relaciones
  ordenes_asignadas OrdenServicio[] @relation("TecnicoAsignado")
  ordenes_creadas   OrdenServicio[] @relation("CreadoPor")
  
  @@map("usuarios")
}

// ============ CLIENTES ============

model Cliente {
  id              String    @id @default(uuid())
  nombre          String
  identificacion  String?
  tipo_id         String    @default("cedula") // 'cedula' | 'ruc' | 'pasaporte'
  email           String?
  telefono        String?
  direccion       String?
  password        String?   // Para portal de clientes
  
  empresa_id      String
  empresa         Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  
  // Relaciones
  ordenes         OrdenServicio[]
  ventas          Venta[]
  
  @@unique([empresa_id, identificacion])
  @@map("clientes")
}

// ============ ÓRDENES DE SERVICIO ============

model OrdenServicio {
  id                  String    @id @default(uuid())
  numero              String    // Ej: "ORD-001-0001"
  
  // Cliente
  cliente_id          String
  cliente             Cliente   @relation(fields: [cliente_id], references: [id])
  
  // Equipo
  equipo_tipo         String    // 'herramienta' | 'electrodomestico' | 'otro'
  equipo_marca        String
  equipo_modelo       String?
  equipo_serie        String?
  equipo_accesorios   String?
  
  // Problema
  problema_reportado  String
  diagnostico         String?
  solucion            String?
  
  // Estado
  estado              String    @default("recibido") // 'recibido' | 'diagnostico' | 'cotizado' | 'aprobado' | 'reparando' | 'listo' | 'entregado' | 'cancelado'
  prioridad           String    @default("normal") // 'baja' | 'normal' | 'alta' | 'urgente'
  
  // Costos
  costo_estimado      Decimal?  @db.Decimal(10, 2)
  costo_final         Decimal?  @db.Decimal(10, 2)
  anticipo            Decimal?  @db.Decimal(10, 2)
  
  // Fechas
  fecha_recepcion     DateTime  @default(now())
  fecha_promesa       DateTime?
  fecha_entrega       DateTime?
  
  // Técnico
  tecnico_id          String?
  tecnico             Usuario?  @relation("TecnicoAsignado", fields: [tecnico_id], references: [id])
  
  // Creador
  creado_por_id       String?
  creado_por          Usuario?  @relation("CreadoPor", fields: [creado_por_id], references: [id])
  
  // Empresa
  empresa_id          String
  empresa             Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  
  // QR
  qr_code             String?
  
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt
  
  @@unique([empresa_id, numero])
  @@map("ordenes_servicio")
}

// ============ INVENTARIO ============

model Producto {
  id              String    @id @default(uuid())
  codigo          String
  nombre          String
  descripcion     String?
  categoria       String?
  marca           String?
  
  precio_compra   Decimal   @db.Decimal(10, 2)
  precio_venta    Decimal   @db.Decimal(10, 2)
  stock           Int       @default(0)
  stock_minimo    Int       @default(5)
  
  activo          Boolean   @default(true)
  
  empresa_id      String
  empresa         Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  
  // Relaciones
  detalles_venta  VentaDetalle[]
  
  @@unique([empresa_id, codigo])
  @@map("productos")
}

// ============ VENTAS / POS ============

model Venta {
  id              String    @id @default(uuid())
  numero          String    // Ej: "VTA-001-0001"
  
  cliente_id      String?
  cliente         Cliente?  @relation(fields: [cliente_id], references: [id])
  
  subtotal        Decimal   @db.Decimal(10, 2)
  iva             Decimal   @db.Decimal(10, 2)
  descuento       Decimal   @default(0) @db.Decimal(10, 2)
  total           Decimal   @db.Decimal(10, 2)
  
  metodo_pago     String    @default("efectivo") // 'efectivo' | 'tarjeta' | 'transferencia'
  estado          String    @default("completada") // 'pendiente' | 'completada' | 'anulada'
  
  empresa_id      String
  empresa         Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  
  // Relaciones
  detalles        VentaDetalle[]
  
  @@unique([empresa_id, numero])
  @@map("ventas")
}

model VentaDetalle {
  id              String    @id @default(uuid())
  
  venta_id        String
  venta           Venta     @relation(fields: [venta_id], references: [id], onDelete: Cascade)
  
  producto_id     String
  producto        Producto  @relation(fields: [producto_id], references: [id])
  
  cantidad        Int
  precio_unitario Decimal   @db.Decimal(10, 2)
  subtotal        Decimal   @db.Decimal(10, 2)
  
  @@map("ventas_detalle")
}

// ============ NOTIFICACIONES ============

model Notificacion {
  id          String    @id @default(uuid())
  tipo        String    // 'orden' | 'pago' | 'sistema' | 'completada'
  titulo      String
  mensaje     String
  leida       Boolean   @default(false)
  link        String?
  
  empresa_id  String
  empresa     Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  
  created_at  DateTime  @default(now())
  
  @@map("notificaciones")
}

// ============ SECUENCIALES ============

model Secuencial {
  id              String    @id @default(uuid())
  tipo_documento  String    // 'factura' | 'nota_credito' | 'orden' | 'venta'
  establecimiento String
  punto_emision   String
  secuencial      Int       @default(1)
  
  empresa_id      String
  empresa         Empresa   @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  
  @@unique([empresa_id, tipo_documento, establecimiento, punto_emision])
  @@map("secuenciales")
}

// ============ SRI CONFIGURACIÓN ============

model SriConfiguracion {
  id                          String    @id @default(uuid())
  empresa_id                  String    @unique
  
  razon_social                String?
  nombre_comercial            String?
  direccion_matriz            String?
  establecimiento             String    @default("001")
  punto_emision               String    @default("001")
  direccion_establecimiento   String?
  ambiente                    String    @default("pruebas")
  obligado_contabilidad       Boolean   @default(false)
  contribuyente_especial      String?
  tipo_emision                String    @default("1")
  
  firma_electronica_configurada Boolean @default(false)
  firma_electronica_vence     DateTime?
  
  created_at                  DateTime  @default(now())
  updated_at                  DateTime  @updatedAt
  
  @@map("sri_configuracion")
}
